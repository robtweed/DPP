let KV=class{constructor(){this.listeners=new Map,this.transforms={toLowerCase:function(e){return e.toLowerCase()},toString:function(e){return e.toString()},toInteger:function(e){return parseInt(e)},removePunctuation:function(e){return e.replace(/[^\w\s\']|_/g,"").replace(/\s+/g," ")}}}static async start(e){let t=e.index,s=e.logging||!1;!t||t.transforms||t.props||(t=!1),t&&(t.transforms&&(Array.isArray(t.transforms)||(t.transforms=[t.transforms])),t.props&&(Array.isArray(t.props)||(t.props=[t.props])));const r=new KV;let i,n=new e.DPP({idb_name:e.idb_name,storeName:e.storeName,logging:s,QOper8:e.QOper8,qOptions:e.qOptions});if(r.DPP=n,e.auth&&(i={auth:e.auth}),r.store=await n.start(i),r.store.data){(JSON.stringify(t)||"false")!==(JSON.stringify(r.store.indexing)||"false")&&(t?(r.store.indexing=t,t||delete r.store.indexing,r.reIndex()):(delete r.store.index,delete r.store.indexing))}else r.store.data={},t&&(r.store.indexing=t);return r.storeName=e.storeName,r}getIndexKey(e){if(this.store.indexing){if("object"==typeof e){if(this.store.indexing.props){let t=[];for(const s in e)if(this.store.indexing.props.includes(s)){let r=this.getIndexKey(e[s]);r&&t.push({prop:s,value:r})}return 0!==t.length&&t}return!1}if(this.store.indexing.transforms)for(const t of this.store.indexing.transforms)this.transforms[t]&&(e=this.transforms[t](e));return e}return!1}addIndex(e,t,s,r){if(this.store.index||(this.store.index={}),void 0===this.store.index[e]&&(this.store.index[e]={}),s){let r={};r[s]=!0,this.store.index[e][t]=r}else this.store.index[e][t]=!0}set(e,t,s){this.store.data[e]=t;let r=this.getIndexKey(t);if(r)if(Array.isArray(r))for(const t of r)this.addIndex(t.value,e,t.prop);else this.addIndex(r,e,null)}get(e){return this.store.data[e]}getByIndex(e,t){let s=[],r=this.getIndexKey(e);if(r)for(const e in this.store.index[r])if(t){let t={key:e,data:this.get(e)};s.push(t)}else s.push(e);return s}search(e,t){let s=[],r=this.getIndexKey(e);if(r)for(const e in this.store.index)if(e.includes(r)){let r=this.getByIndex(e,t);s=s.concat(r)}return s}has(e){return void 0!==this.store.data[e]}deleteIndex(e,t,s,r){s?(delete this.store.index[e][t][s],this.DPP.isEmpty(this.store.index[e][t])&&delete this.store.index[e][t]):delete this.store.index[e][t],this.DPP.isEmpty(this.store.index[e])&&delete this.store.index[e]}delete(e,t){if(this.has(e)){let t=this.getIndexKey(this.get(e));if(t)if(Array.isArray(t))for(const s of t)this.deleteIndex(s.value,e,s.prop);else this.deleteIndex(t,e,null);delete this.store.data[e]}}reIndex(){delete this.store.index;for(const e in this.store.data){let t=this.get(e);this.set(e,t)}}get hasKeys(){for(const e in this.store.data)return!0;return!1}get isEmpty(){return!this.hasKeys}clear(){for(const e in this.store.data)this.delete(e)}dump(){return JSON.stringify(this.store,null,2)}on(e,t){this.listeners.has(e)||this.listeners.set(e,t)}off(e){this.listeners.has(e)&&this.listeners.delete(e)}emit(e,t){if(this.listeners.has(e)){this.listeners.get(e).call(this,t)}}};export{KV};
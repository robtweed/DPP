self.handler=async function(e,t){let r,n=this;const o=class{constructor(e,t){this.name=e;let o,i=!1,s=!1;t?(o=t,i=!0):s=!0;let a=this;this.isAuthenticated=function(){return i},this.setSignature=async function(e){if(i){let t={id:["signature"],value:o.getHash(r)};await a.put(t,void 0,e)}},this.isValidSignature=function(e){return e===o.getHash(r)},this.setReady=function(e){e===r&&(s=!0)},this.isReady=function(e){return e===r&&s},this.retrieve=async function(e){if(e!==r)return{};let t=[];await a.iterate(function(e,r){t.push({key:e,value:r})});let n=[];if(i&&s)for(let e=0;e<t.length;e++){let r=t[e],i=r.value;"signature"!==r.key[0]&&(i=await o.decrypt(i),n.push({key:r.key,value:i}))}else n=t;let c={};return n.forEach(function(e){let t=e.key,r=e.value;var n=c;t.forEach(function(e,o){if(Array.isArray(e)&&(e=+e[0]),o===t.length-1)n[e]=r;else{let r=t[o+1];Array.isArray(r)?void 0===n[e]&&(n[e]=[]):void 0===n[e]&&(n[e]={}),n=n[e]}})}),c},this.put_item=async function(e,t,r){if(i&&s&&(t.value=await o.encrypt(t.value)),!self.idb.db)return r({error:"addItem Error: Database has not been opened"});r||(r=t,t=e,e=null);let a=this.getObjectStore("readwrite"),c=a.put(t);c.onsuccess=function(){n.emit("putCommitted",{objectStore:a,value:t}),r({key:c.result})},c.onerror=function(){r({error:c.error})}}}getObjectStore(e){return self.idb.db.transaction(this.name,e).objectStore(this.name)}isValidToken(e){return e===r}iterate_db(e,t,r){let n;t||"function"!=typeof e||(t=e,e=null);let o="";e&&(n=IDBKeyRange.lowerBound(e),o=e.toString()+",");this.getObjectStore().openCursor(n).onsuccess=function(n){let i=n.target.result;if(i){let n=i.value,s=n.id,a=n.value;if(e){let e=s.toString()+",";""!==o&&e.startsWith(o)?(t&&t(s,a),i.continue()):r&&"function"==typeof r&&r()}else t&&t(s,a),i.continue()}else r&&"function"==typeof r&&r()}}iterate(e,t){t||"function"!=typeof e||(t=e,e=null);let r=this;return new Promise(n=>{r.iterate_db(e,t,function(){n()})})}async clearByKey(e,t){if(t!==r)return!1;let n=this;await this.iterate(e,async function(e){await n.delete(e)})}clear_db(e){if(!self.idb.db)return e({error:"clear() Error: Database has not been opened"});let t=this.getObjectStore("readwrite").clear();t.onsuccess=function(){e({ok:!0})},t.onerror=function(){e({error:t.error})}}clear(){let e=this;return new Promise(t=>{e.clear_db(function(e){t(e)})})}count_items(e){if(!self.idb.db)return e({error:"count Error: Database has not been opened"});let t=this.getObjectStore("readonly").count();t.onsuccess=function(){e(t.result)},t.onerror=function(){e({error:t.error})}}count(){let e=this;return new Promise(t=>{e.count_items(function(e){t(e)})})}put(e,t,n){if(n!==r)return!1;t||(t=e,e=null);let o=this;return new Promise(async r=>{await o.put_item(e,t,function(e){r(e)})})}get_item(e,t){if(!self.idb.db)return t({error:"get_item Error: Database has not been opened"});let r=this.getObjectStore("readonly").get(e);r.onsuccess=function(){t(r.result)},r.onerror=function(){t({error:r.error})}}get(e){let t=this;return new Promise(r=>{t.get_item(e,function(e){r(e)})})}delete_item(e,t){if(!self.idb.db)return t({error:"delete_item Error: Database has not been opened"});let r=this.getObjectStore("readwrite"),o=r.delete(e);o.onsuccess=function(){n.emit("deleteCommitted",{objectStore:r,key:e}),t({ok:!0})},o.onerror=function(){t({error:o.error})}}delete(e){let t=this;return new Promise(r=>{t.delete_item(e,function(e){r(e)})})}};async function i(e,t,r){const n=await crypto.subtle.encrypt({iv:r,name:"AES-GCM"},t,(new TextEncoder).encode(e));var o;return o=n,btoa(String.fromCharCode(...new Uint8Array(o)))}async function s(e,t,r){let n=function(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=t.charCodeAt(e);return n.buffer}(e),o=await crypto.subtle.decrypt({iv:r,name:"AES-GCM"},t,n);return o=(new TextDecoder).decode(o)}function a(e,t){let r={};t?r.keyPath=t:r.autoIncrement=!0,self.idb.objectStores.set(e,r)}function c(e,t,r){if(!self.idb.store)return r({error:"Open Database Error: Store Name not defined"});r||(r=e,e=null);let i=indexedDB.open(self.idb.store,e);i.onsuccess=function(e){self.idb.db=e.target.result,n.emit("databaseOpen",self.idb.db),r({db:self.idb.db})},i.onerror=function(e){r({error:e.target.errorCode})},i.onupgradeneeded=function(e){self.idb.db=e.target.result,function(e){if(self.idb)for(const[t,r]of self.idb.objectStores.entries())self.idb.db.objectStoreNames.contains(t)||(self.idb.db.createObjectStore(t,r),self.idb.stores[t]||(self.idb.stores[t]=new o(t,e)))}(t)}}async function u(e,t){return new Promise(r=>{c(e,t,function(e){r(e)})})}let l;if(self.idb||(self.idb={objectStores:new Map,stores:{},store:e.idb_name}),r=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)),e.qoper8&&e.qoper8.auth){let n=e.qoper8.auth;if(!n.username||""===n.username)return t({error:"Authentication credentials are missing"});if(!n.password||""===n.password)return t({error:"Authentication credentials are missing"});let o=await async function(e,t){const r=e=>new Uint8Array([...unescape(encodeURIComponent(e))].map(e=>e.charCodeAt(0))),n=r(t),o=r(e),i=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!0,["sign"]),s=await crypto.subtle.sign("HMAC",i,o);return btoa(String.fromCharCode(...new Uint8Array(s)))}(n.username,n.password),a=await async function(e){let t=await async function(e){return await crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e))}(e);return await crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!1,["encrypt","decrypt"])}(n.username+":"+n.password);l={getHash:function(e){return e===r&&o},encrypt:async function(e){let t=crypto.getRandomValues(new Uint8Array(12));return{encrypt:await i(e,a,t),iv:t}},decrypt:async function(e){return await s(e.encrypt,a,e.iv)}}}let d=e.objectStores||[];for(const e of d)a(e,"id");await u(void 0,l);let f=!1;for(const e of self.idb.objectStores.keys())self.idb.db.objectStoreNames.contains(e)||(f=!0),self.idb.stores[e]=new o(e,l);if(f){let e=self.idb.db.version+1;self.idb.db.close(),await u(e,l),n.emit("databaseReady",{objectStores:d}),t({db_ready:!0,qoper8:{token:r}})}else this.emit("databaseReady",{objectStores:d}),t({db_ready:!0,qoper8:{token:r}})};